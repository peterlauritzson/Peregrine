//--------------------------------------------------------------------------------------------------
// Race Draft System
//--------------------------------------------------------------------------------------------------

// Constants
const int c_peregrine_raceTerran = 1;
const int c_peregrine_raceProtoss = 2;
const int c_peregrine_raceZerg = 3;

// State
int g_draft_p1; // The banning player
int g_draft_p2; // The picking player
playergroup g_draft_team1; // Team 1 Players
playergroup g_draft_team2; // Team 2 Players
bool g_draft_p1_is_team1; // True if P1 (Banner) represents Team 1
int g_draft_bannedRace = 0;
int g_draft_phase = 0; // 0 = Ban, 1 = Pick
trigger g_draft_trigger;

// UI
int g_draft_dialog = c_invalidDialogId;
int g_draft_label = c_invalidDialogControlId;
int g_draft_btnTerran = c_invalidDialogControlId;
int g_draft_btnProtoss = c_invalidDialogControlId;
int g_draft_btnZerg = c_invalidDialogControlId;

//--------------------------------------------------------------------------------------------------
// Helper: Get Race Config ID
//--------------------------------------------------------------------------------------------------
string GetRaceConfigId(int race) {
    if (race == c_peregrine_raceTerran) { return "Terran"; }
    if (race == c_peregrine_raceProtoss) { return "Protoss"; }
    if (race == c_peregrine_raceZerg) { return "Zerg"; }
    return "";
}

//--------------------------------------------------------------------------------------------------
// Helper: Get Race Name
//--------------------------------------------------------------------------------------------------
string RaceName(int race) {
    return GetRaceConfigId(race);
}

//--------------------------------------------------------------------------------------------------
// Helper: Get Race Unit Type
//--------------------------------------------------------------------------------------------------
string GetRaceUnitType(int race, string field) {
    string raceId = GetRaceConfigId(race);
    if (raceId == "") { return ""; }
    return UserDataGetGameLink("PeregrineRaceStartConfig", raceId, field, 1);
}

//--------------------------------------------------------------------------------------------------
// Helper: Get Race Start Config Int
//--------------------------------------------------------------------------------------------------
int GetRaceStartConfigInt(int race, string field) {
    string raceId = GetRaceConfigId(race);
    if (raceId == "") { return 0; }
    return UserDataGetInt("PeregrineRaceStartConfig", raceId, field, 1);
}

//--------------------------------------------------------------------------------------------------
// Debug: Dump Config
//--------------------------------------------------------------------------------------------------
void DumpDraftConfigToLog(int race) {
    string dump = "--- Draft Config Dump (" + RaceName(race) + ") ---\n";
    dump = dump + "WorkerCount: " + IntToString(GetRaceStartConfigInt(race, "WorkerCount")) + "\n";
    dump = dump + "Minerals:    " + IntToString(GetRaceStartConfigInt(race, "Minerals")) + "\n";
    dump = dump + "Vespene:     " + IntToString(GetRaceStartConfigInt(race, "Vespene")) + "\n";
    dump = dump + "-------------------------";
    
    Debug_Log(dump);
}

//--------------------------------------------------------------------------------------------------
// Helper: Replace Army
//--------------------------------------------------------------------------------------------------
void SetPlayerRace(int player, int race) {
    unitgroup existingUnits;
    unit u;
    point startLoc;
    string townHallType;
    string workerType;
    string extraUnitType;
    int i;
    int workerCount = GetRaceStartConfigInt(race, "WorkerCount");
    int minerals = GetRaceStartConfigInt(race, "Minerals");
    int vespene = GetRaceStartConfigInt(race, "Vespene");

    DumpDraftConfigToLog(race);

    // 1. Determine Unit Types
    townHallType = GetRaceUnitType(race, "TownHall");
    workerType = GetRaceUnitType(race, "Worker");
    extraUnitType = GetRaceUnitType(race, "ExtraUnit");

    // 2. Find Start Location (where the current Town Hall is)
    existingUnits = UnitGroup(null, player, RegionEntireMap(), UnitFilter(0, 0, (1 << c_targetFilterMissile), (1 << (c_targetFilterDead - 32)) | (1 << (c_targetFilterHidden - 32))), 0);
    startLoc = PlayerStartLocation(player); // Default fallback

    // Try to find the actual town hall to get precise location
    i = 1;
    while (i <= UnitGroupCount(existingUnits, c_unitCountAll)) {
        u = UnitGroupUnit(existingUnits, i);
        if (UnitTypeTestAttribute(UnitGetType(u), c_unitAttributeStructure)) {
            startLoc = UnitGetPosition(u);
            break;
        }
        i = i + 1;
    }

    // 3. Destroy Old Units
    UnitGroupLoopBegin(existingUnits);
    while (!UnitGroupLoopDone()) {
        UnitRemove(UnitGroupLoopCurrent());
        UnitGroupLoopStep();
    }
    UnitGroupLoopEnd();

    // 4. Spawn New Units
    libNtve_gf_CreateUnitsWithDefaultFacing(1, townHallType, 0, player, startLoc);
    libNtve_gf_CreateUnitsWithDefaultFacing(workerCount, workerType, 0, player, startLoc);
    
    // Spawn Extra Unit (e.g. Overlord) if defined
    if (extraUnitType != "") {
        libNtve_gf_CreateUnitsWithDefaultFacing(1, extraUnitType, 0, player, startLoc);
    }

    // 5. Set Resources (Standard Melee Start)
    PlayerModifyPropertyInt(player, c_playerPropMinerals, c_playerPropOperSetTo, minerals);
    PlayerModifyPropertyInt(player, c_playerPropVespene, c_playerPropOperSetTo, vespene);
}

//--------------------------------------------------------------------------------------------------
// Helper: Replace Army for Team
//--------------------------------------------------------------------------------------------------
void SetTeamRace(playergroup team, int race) {
    int i = 1;
    int count = PlayerGroupCount(team);
    int p;

    while (i <= count) {
        p = PlayerGroupPlayer(team, i);
        SetPlayerRace(p, race);
        i = i + 1;
    }
}

//--------------------------------------------------------------------------------------------------
// Helper: Remove Workers
//--------------------------------------------------------------------------------------------------
void RemoveWorkers() {
    // UnitFilter(0, 0, 0, 0) selects everything.
    unitgroup g = UnitGroup(null, c_playerAny, RegionEntireMap(), UnitFilter(0, 0, 0, 0), 0);
    unit u;
    string type;
    int owner;

    UnitGroupLoopBegin(g);
    while (!UnitGroupLoopDone()) {
        u = UnitGroupLoopCurrent();
        owner = UnitGetOwner(u);
        
        // Only check units owned by actual players (1-15)
        if (owner != 0) {
            type = UnitGetType(u);
            if (type == "SCV" || type == "Probe" || type == "Drone") {
                UnitRemove(u);
            }
        }
        UnitGroupLoopStep();
    }
    UnitGroupLoopEnd();
}

//--------------------------------------------------------------------------------------------------
// Logic: Finish Draft
//--------------------------------------------------------------------------------------------------
void RaceDraft_Finish(int pickedRace) {
    int p1Race;
    int t1Race;
    int t2Race;
    string msg;
    
    // Determine P1's race (The one that wasn't banned and wasn't picked)
    if (g_draft_bannedRace != c_peregrine_raceTerran && pickedRace != c_peregrine_raceTerran) { p1Race = c_peregrine_raceTerran; }
    else if (g_draft_bannedRace != c_peregrine_raceProtoss && pickedRace != c_peregrine_raceProtoss) { p1Race = c_peregrine_raceProtoss; }
    else { p1Race = c_peregrine_raceZerg; }

    // Apply to Teams
    // P1 is the Banner. They get the "Remainder" race (p1Race).
    // P2 is the Picker. They get the "Picked" race (pickedRace).
    if (g_draft_p1_is_team1) {
        t1Race = p1Race;
        t2Race = pickedRace;
    } else {
        t1Race = pickedRace;
        t2Race = p1Race;
    }

    SetTeamRace(g_draft_team1, t1Race);
    SetTeamRace(g_draft_team2, t2Race);
    
    // Cleanup UI
    DialogDestroy(g_draft_dialog);
    
    // Unpause
    GameSetMissionTimePaused(false);

    // Announce
    msg = "Draft Complete! Team 1: " + RaceName(t1Race) + ", Team 2: " + RaceName(t2Race);
    UIDisplayMessage(PlayerGroupAll(), c_messageAreaChat, StringToText(msg));
}

//--------------------------------------------------------------------------------------------------
// Logic: Update UI
//--------------------------------------------------------------------------------------------------
void RaceDraft_UpdateUI() {
    if (g_draft_phase == 0) {
        // Ban Phase (P1)
        DialogControlSetPropertyAsText(g_draft_label, c_triggerControlPropertyText, PlayerGroupSingle(g_draft_p1), StringToText("BAN a Race"));
        
        // Show all buttons to P1
        DialogControlSetVisible(g_draft_btnTerran, PlayerGroupSingle(g_draft_p1), true);
        DialogControlSetVisible(g_draft_btnProtoss, PlayerGroupSingle(g_draft_p1), true);
        DialogControlSetVisible(g_draft_btnZerg, PlayerGroupSingle(g_draft_p1), true);
        
        // Only update P2 view if P2 is a different player (avoids overwriting P1 view in solo testing)
        if (g_draft_p1 != g_draft_p2) {
            DialogControlSetPropertyAsText(g_draft_label, c_triggerControlPropertyText, PlayerGroupSingle(g_draft_p2), StringToText("Opponent is Banning..."));
            
            // Hide buttons from P2
            DialogControlSetVisible(g_draft_btnTerran, PlayerGroupSingle(g_draft_p2), false);
            DialogControlSetVisible(g_draft_btnProtoss, PlayerGroupSingle(g_draft_p2), false);
            DialogControlSetVisible(g_draft_btnZerg, PlayerGroupSingle(g_draft_p2), false);
        }
    }
    else {
        // Pick Phase (P2)
        DialogControlSetPropertyAsText(g_draft_label, c_triggerControlPropertyText, PlayerGroupSingle(g_draft_p2), StringToText("PICK your Race"));

        // Show available buttons to P2
        DialogControlSetVisible(g_draft_btnTerran, PlayerGroupSingle(g_draft_p2), (g_draft_bannedRace != c_peregrine_raceTerran));
        DialogControlSetVisible(g_draft_btnProtoss, PlayerGroupSingle(g_draft_p2), (g_draft_bannedRace != c_peregrine_raceProtoss));
        DialogControlSetVisible(g_draft_btnZerg, PlayerGroupSingle(g_draft_p2), (g_draft_bannedRace != c_peregrine_raceZerg));

        // Only update P1 view if P1 is a different player
        if (g_draft_p1 != g_draft_p2) {
            DialogControlSetPropertyAsText(g_draft_label, c_triggerControlPropertyText, PlayerGroupSingle(g_draft_p1), StringToText("Opponent is Picking..."));

            // Hide buttons from P1
            DialogControlSetVisible(g_draft_btnTerran, PlayerGroupSingle(g_draft_p1), false);
            DialogControlSetVisible(g_draft_btnProtoss, PlayerGroupSingle(g_draft_p1), false);
            DialogControlSetVisible(g_draft_btnZerg, PlayerGroupSingle(g_draft_p1), false);
        }
    }
}

//--------------------------------------------------------------------------------------------------
// Handler: Button Click
//--------------------------------------------------------------------------------------------------
bool RaceDraft_OnClicked(bool testConds, bool runActions) {
    int control = EventDialogControl();
    int player = EventPlayer();
    int selectedRace = 0;

    if (control == g_draft_btnTerran) { selectedRace = c_peregrine_raceTerran; }
    else if (control == g_draft_btnProtoss) { selectedRace = c_peregrine_raceProtoss; }
    else if (control == g_draft_btnZerg) { selectedRace = c_peregrine_raceZerg; }

    if (selectedRace == 0) { return true; }

    if (g_draft_phase == 0) {
        // Ban Phase
        if (player != g_draft_p1) { return true; }
        g_draft_bannedRace = selectedRace;
        g_draft_phase = 1;
        RaceDraft_UpdateUI();
    }
    else {
        // Pick Phase
        if (player != g_draft_p2) { return true; }
        RaceDraft_Finish(selectedRace);
    }

    return true;
}

//--------------------------------------------------------------------------------------------------
// Main: Start Draft
//--------------------------------------------------------------------------------------------------
void RaceDraft_Start() {
    int i;
    int p;
    int decider1 = 0;
    int decider2 = 0;
    bool team1HasHuman = false;
    bool team2HasHuman = false;
    int team1Leader = 0;
    int team2Leader = 0;

    // Initialize Groups
    g_draft_team1 = PlayerGroupEmpty();
    g_draft_team2 = PlayerGroupEmpty();

    // Wait for initialization to complete (units to spawn)
    Wait(0.1, c_timeGame);

    // 1. Scan Players and Teams
    i = 1;
    while (i <= 15) { // Max players usually
        if (PlayerStatus(i) == c_playerStatusActive) {
            
            // Logic: Determine Team based on Alliance
            // If Team 1 is empty, start it
            if (PlayerGroupCount(g_draft_team1) == 0) {
                PlayerGroupAdd(g_draft_team1, i);
                team1Leader = i;
                if (PlayerType(i) == c_playerTypeUser) {
                    team1HasHuman = true;
                    decider1 = i;
                }
            }
            // Check if allied with Team 1 Leader (Passive Alliance is the standard "Ally" check)
            else if (PlayerGetAlliance(i, team1Leader, c_allianceIdPassive)) {
                PlayerGroupAdd(g_draft_team1, i);
                if (PlayerType(i) == c_playerTypeUser) {
                    team1HasHuman = true;
                    if (decider1 == 0) { decider1 = i; }
                }
            }
            // If Team 2 is empty, start it
            else if (PlayerGroupCount(g_draft_team2) == 0) {
                PlayerGroupAdd(g_draft_team2, i);
                team2Leader = i;
                if (PlayerType(i) == c_playerTypeUser) {
                    team2HasHuman = true;
                    decider2 = i;
                }
            }
            // Check if allied with Team 2 Leader
            else if (PlayerGetAlliance(i, team2Leader, c_allianceIdPassive)) {
                PlayerGroupAdd(g_draft_team2, i);
                if (PlayerType(i) == c_playerTypeUser) {
                    team2HasHuman = true;
                    if (decider2 == 0) { decider2 = i; }
                }
            }
            else {
                // Error: 3rd team found or unallied player
                UIDisplayMessage(PlayerGroupAll(), c_messageAreaChat, StringToText("Error: More than 2 teams detected. Draft aborted."));
                return;
            }
        }
        i = i + 1;
    }

    // 2. Handle Solo / PvAI (One team has no humans)
    if (!team1HasHuman && !team2HasHuman) {
        // All AI? Just return.
        Debug_Log("Draft Skipped: No human players found.");
        return; 
    }
    
    if (team1HasHuman && !team2HasHuman) {
        // Team 1 is sole human team. Decider1 decides for both.
        decider2 = decider1;
        Debug_Log("Solo/PvAI Mode: Player " + IntToString(decider1) + " controls draft.");
    }
    else if (!team1HasHuman && team2HasHuman) {
        // Team 2 is sole human team. Decider2 decides for both.
        decider1 = decider2;
        Debug_Log("Solo/PvAI Mode: Player " + IntToString(decider2) + " controls draft.");
    }

    // 3. Assign Draft Roles (Randomize who bans/picks)
    if (RandomInt(0, 1) == 0) {
        g_draft_p1 = decider1; // Team 1 Bans
        g_draft_p2 = decider2; // Team 2 Picks
        g_draft_p1_is_team1 = true;
    } else {
        g_draft_p1 = decider2; // Team 2 Bans
        g_draft_p2 = decider1; // Team 1 Picks
        g_draft_p1_is_team1 = false;
    }

    // Pause Game
    GameSetMissionTimePaused(true);
    RemoveWorkers();

    // Create UI
    g_draft_dialog = DialogCreate(500, 400, c_anchorCenter, 0, 0, true);
    DialogSetTitle(g_draft_dialog, StringToText("Peregrine Draft"));
    DialogSetVisible(g_draft_dialog, PlayerGroupAll(), true);

    // Label
    g_draft_label = DialogControlCreate(g_draft_dialog, c_triggerControlTypeLabel);
    DialogControlSetSize(g_draft_label, PlayerGroupAll(), 400, 50);
    DialogControlSetPosition(g_draft_label, PlayerGroupAll(), c_anchorTop, 0, 80);
    DialogControlSetPropertyAsText(g_draft_label, c_triggerControlPropertyText, PlayerGroupAll(), StringToText("Initializing..."));

    // Buttons
    g_draft_btnTerran = DialogControlCreate(g_draft_dialog, c_triggerControlTypeButton);
    DialogControlSetSize(g_draft_btnTerran, PlayerGroupAll(), 200, 50);
    DialogControlSetPosition(g_draft_btnTerran, PlayerGroupAll(), c_anchorTop, 0, 150);
    DialogControlSetPropertyAsText(g_draft_btnTerran, c_triggerControlPropertyText, PlayerGroupAll(), StringToText("Terran"));

    g_draft_btnProtoss = DialogControlCreate(g_draft_dialog, c_triggerControlTypeButton);
    DialogControlSetSize(g_draft_btnProtoss, PlayerGroupAll(), 200, 50);
    DialogControlSetPosition(g_draft_btnProtoss, PlayerGroupAll(), c_anchorTop, 0, 210);
    DialogControlSetPropertyAsText(g_draft_btnProtoss, c_triggerControlPropertyText, PlayerGroupAll(), StringToText("Protoss"));

    g_draft_btnZerg = DialogControlCreate(g_draft_dialog, c_triggerControlTypeButton);
    DialogControlSetSize(g_draft_btnZerg, PlayerGroupAll(), 200, 50);
    DialogControlSetPosition(g_draft_btnZerg, PlayerGroupAll(), c_anchorTop, 0, 270);
    DialogControlSetPropertyAsText(g_draft_btnZerg, c_triggerControlPropertyText, PlayerGroupAll(), StringToText("Zerg"));

    // Register Trigger
    g_draft_trigger = TriggerCreate("RaceDraft_OnClicked");
    TriggerAddEventDialogControl(g_draft_trigger, c_playerAny, g_draft_btnTerran, c_triggerControlEventTypeClick);
    TriggerAddEventDialogControl(g_draft_trigger, c_playerAny, g_draft_btnProtoss, c_triggerControlEventTypeClick);
    TriggerAddEventDialogControl(g_draft_trigger, c_playerAny, g_draft_btnZerg, c_triggerControlEventTypeClick);

    // Start
    RaceDraft_UpdateUI();
}
